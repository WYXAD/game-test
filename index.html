<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Mario Style Car Game</title>
    <style>
        body { margin: 0; overflow: hidden; background: #5c94fc; font-family: 'Courier New', Courier, monospace; }
        #ui { position: absolute; top: 20px; left: 20px; color: white; font-size: 20px; text-shadow: 2px 2px #000; }
        canvas { display: block; }
    </style>
</head>
<body>
    <div id="ui">Score: <span id="score">0</span><br>A/D: 加速・ブレーキ | Space: ジャンプ</div>
    <canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreElement = document.getElementById('score');

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// ゲーム設定
let score = 0;
const gravity = 0.6;
const friction = 0.98; // 摩擦（これがあるから車っぽい）

const car = {
    x: 100, y: 0, w: 60, h: 30,
    vx: 0, vy: 0, speed: 0.5,
    jumpForce: -12, grounded: false,
    color: '#ff0000'
};

// ステージオブジェクト（x, y, width, height, type）
const world = [
    { x: 0, y: canvas.height - 60, w: 2000, h: 60, type: 'ground' }, // 長い地面
    { x: 400, y: canvas.height - 180, w: 100, h: 40, type: 'block' },
    { x: 500, y: canvas.height - 180, w: 100, h: 40, type: 'block' },
    { x: 800, y: canvas.height - 250, w: 150, h: 30, type: 'block' },
    { x: 1200, y: canvas.height - 150, w: 200, h: 30, type: 'block' }
];

// コイン
let coins = [
    { x: 450, y: canvas.height - 220, collected: false },
    { x: 550, y: canvas.height - 220, collected: false },
    { x: 850, y: canvas.height - 300, collected: false },
    { x: 1300, y: canvas.height - 200, collected: false }
];

const goal = { x: 1800, y: canvas.height - 260, w: 20, h: 200 };

const keys = {};
window.addEventListener('keydown', e => keys[e.code] = true);
window.addEventListener('keyup', e => keys[e.code] = false);

function update() {
    // 車の加速
    if (keys['KeyD'] || keys['ArrowRight']) car.vx += car.speed;
    if (keys['KeyA'] || keys['ArrowLeft']) car.vx -= car.speed;
    
    // ジャンプ
    if ((keys['Space'] || keys['ArrowUp']) && car.grounded) {
        car.vy = car.jumpForce;
        car.grounded = false;
    }

    // 物理演算
    car.vx *= friction;
    car.vy += gravity;
    car.x += car.vx;
    car.y += car.vy;

    // 当たり判定
    car.grounded = false;
    world.forEach(obj => {
        if (car.x < obj.x + obj.w && car.x + car.w > obj.x &&
            car.y < obj.y + obj.h && car.y + car.h > obj.y) {
            if (car.vy > 0) {
                car.vy = 0;
                car.y = obj.y - car.h;
                car.grounded = true;
            }
        }
    });

    // コイン取得
    coins.forEach(c => {
        if (!c.collected && car.x < c.x + 20 && car.x + car.w > c.x && car.y < c.y + 20 && car.y + car.h > c.y) {
            c.collected = true;
            score += 100;
            scoreElement.innerText = score;
        }
    });

    // ゴール判定
    if (car.x > goal.x) {
        alert("GOAL!! スコア: " + score);
        resetGame();
    }

    // 画面外落下
    if (car.y > canvas.height) resetGame();
}

function resetGame() {
    car.x = 100; car.y = 0; car.vx = 0; car.vy = 0;
    score = 0; scoreElement.innerText = score;
    coins.forEach(c => c.collected = false);
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // カメラ風に画面をスライド（車を中心に）
    ctx.save();
    ctx.translate(-car.x + 100, 0);

    // 地面とブロック
    world.forEach(obj => {
        ctx.fillStyle = obj.type === 'ground' ? '#70483c' : '#ab5233';
        ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
        ctx.strokeStyle = '#000';
        ctx.strokeRect(obj.x, obj.y, obj.w, obj.h);
    });

    // コイン
    ctx.fillStyle = '#fbd424';
    coins.forEach(c => {
        if (!c.collected) {
            ctx.beginPath();
            ctx.arc(c.x, c.y, 10, 0, Math.PI * 2);
            ctx.fill();
        }
    });

    // ゴールポール
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(goal.x, goal.y, goal.w, goal.h);
    ctx.fillStyle = '#00aa00';
    ctx.fillRect(goal.x - 20, goal.y, 20, 30);

    // 車 (簡易的な絵)
    ctx.fillStyle = car.color;
    ctx.fillRect(car.x, car.y, car.w, car.h); // ボディ
    ctx.fillStyle = '#000';
    ctx.fillRect(car.x + 5, car.y + car.h, 15, 10); // 前輪
    ctx.fillRect(car.x + car.w - 20, car.y + car.h, 15, 10); // 後輪
    ctx.fillStyle = '#adf';
    ctx.fillRect(car.x + 35, car.y + 5, 20, 10); // 窓

    ctx.restore();

    requestAnimationFrame(() => {
        update();
        draw();
    });
}

draw();
</script>
</body>
</html>
