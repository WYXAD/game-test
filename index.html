<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slay & Craft RPG: Infinite</title>
    <style>
        :root {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --accent-color: #ffd700;
            --border-color: #444;
            --panel-bg: #1e1e1e;
            --danger-color: #ff4444;
            --heal-color: #44ff44;
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Meiryo', monospace;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        #game-container {
            width: 100%;
            max-width: 900px;
            display: grid;
            grid-template-columns: 320px 1fr;
            grid-template-rows: 1fr 180px;
            gap: 10px;
            padding: 10px;
            box-sizing: border-box;
        }

        /* Status Panel */
        #status-panel {
            grid-row: 1 / 2;
            background: var(--panel-bg);
            border: 2px solid var(--border-color);
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .party-member {
            margin-bottom: 15px;
            padding: 8px;
            border: 1px solid #333;
            background: #252525;
        }

        .hp-bar, .mp-bar {
            width: 100%;
            height: 6px;
            background: #333;
            margin-top: 4px;
        }
        .hp-fill { height: 100%; background: var(--danger-color); transition: width 0.3s; }
        .mp-fill { height: 100%; background: #4444ff; transition: width 0.3s; }

        /* Log Panel */
        #log-panel {
            grid-column: 1 / 3;
            grid-row: 2 / 3;
            background: #000;
            border: 2px solid var(--border-color);
            padding: 10px;
            font-size: 0.85rem;
            overflow-y: auto;
            color: #ccc;
        }
        .log-entry { margin-bottom: 2px; border-bottom: 1px solid #111; }
        .log-hit { color: #ffaa00; }
        .log-heal { color: #00ff00; }

        /* Action Panel */
        #action-panel {
            grid-column: 2 / 3;
            grid-row: 1 / 2;
            background: var(--panel-bg);
            border: 2px solid var(--border-color);
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .tab-buttons { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab-buttons button { flex: 1; padding: 10px; font-weight: bold; }

        button {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 8px;
            cursor: pointer;
            transition: 0.2s;
        }
        button:hover { background: #444; border-color: var(--accent-color); }
        button:disabled { opacity: 0.3; cursor: not-allowed; }

        .enemy-box {
            background: #301010;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            border: 2px solid #600;
            border-radius: 4px;
        }

        .item-row {
            display: flex;
            justify-content: space-between;
            padding: 5px;
            border-bottom: 1px solid #333;
            font-size: 0.9rem;
        }

        .hidden { display: none !important; }
        .gold { color: var(--accent-color); font-weight: bold; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="status-panel">
        <h3 style="margin:0 0 10px 0;">ğŸ›¡ï¸ PARTY</h3>
        <div id="party-list"></div>
        <div style="margin-top:auto; padding-top:10px; border-top:1px solid #444;">
            <p>æ‰€æŒé‡‘: <span id="gold-display" class="gold">0</span> G</p>
            <div id="inventory-summary"></div>
        </div>
    </div>

    <div id="action-panel">
        <div class="tab-buttons">
            <button onclick="changeScene('explore')">âš”ï¸ æ¢ç´¢</button>
            <button onclick="changeScene('town')">ğŸ¡ ç”º</button>
            <button onclick="changeScene('craft')">âš’ï¸ åˆæˆ</button>
            <button onclick="changeScene('equip')">ğŸ’ è£…å‚™</button>
        </div>

        <div id="explore-view" class="view">
            <div class="view-header"><h2 id="area-title">ç„¡é™ã®å›å»Š</h2></div>
            <div id="explore-idle">
                <p>ç¾åœ¨ã®éšå±¤: <strong id="floor-display">1</strong> F</p>
                <button style="width:100%; padding:20px;" onclick="startExplore()">æ¢ç´¢ã‚’é–‹å§‹ã™ã‚‹</button>
            </div>
            
            <div id="battle-area" class="hidden">
                <div class="enemy-box">
                    <h3 id="enemy-name">Monster</h3>
                    <div class="hp-bar"><div id="enemy-hp-fill" class="hp-fill"></div></div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <button onclick="battleTurn('attack')">ãŸãŸã‹ã†</button>
                    <button onclick="battleTurn('skill')">ã‚¹ã‚­ãƒ«æ¶ˆè²»MP</button>
                    <button id="next-btn" class="hidden" onclick="proceedFloor()">æ¬¡ã®éšå±¤ã¸</button>
                    <button id="retreat-btn" onclick="changeScene('town')">ç”ºã¸æˆ»ã‚‹</button>
                </div>
            </div>
        </div>

        <div id="town-view" class="view hidden">
            <h2>ä¼‘æ¯ã®å®¿</h2>
            <p>15Gã§ãƒ‘ãƒ¼ãƒ†ã‚£å…¨å“¡ã®HP/MPã‚’å…¨å¿«ã—ã¾ã™ã€‚</p>
            <button onclick="rest()">å®¿å±‹ã«æ³Šã¾ã‚‹ (15G)</button>
            <hr>
            <button onclick="saveGame()">ã‚»ãƒ¼ãƒ–ã™ã‚‹</button>
        </div>

        <div id="craft-view" class="view hidden">
            <h2>åˆæˆè·äºº</h2>
            <div id="recipe-list" style="overflow-y:auto; flex-grow:1;"></div>
        </div>

        <div id="equip-view" class="view hidden">
            <h2>è£…å‚™å¤‰æ›´</h2>
            <div id="equip-list"></div>
        </div>
    </div>

    <div id="log-panel"></div>
</div>

<script>
// --- ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿å®šç¾© ---
const INITIAL_STATE = {
    gold: 100,
    floor: 1,
    inventory: { "stone": 3 }, // åˆæœŸã‚¢ã‚¤ãƒ†ãƒ 
    ownedEquipment: [], // æ‰€æŒã—ã¦ã„ã‚‹è£…å‚™ {id, name, stat, value}
    party: [
        { id:0, name: "å‹‡è€…", job: "Knight", hp: 60, maxHp: 60, mp: 10, maxMp: 10, atk: 12, def: 8, skillName: "å¼·æ’ƒ", skillCost: 5, weapon: null },
        { id:1, name: "é­”å°å£«", job: "Wizard", hp: 35, maxHp: 35, mp: 40, maxMp: 40, atk: 18, def: 4, skillName: "çˆ†ç‚", skillCost: 12, weapon: null },
        { id:2, name: "åƒ§ä¾¶", job: "Priest", hp: 45, maxHp: 45, mp: 25, maxMp: 25, atk: 6, def: 6, skillName: "ç¥ˆã‚Š", skillCost: 8, weapon: null }
    ]
};

const ITEMS = { "herb": "è–¬è‰", "stone": "å°çŸ³", "iron": "é‰„æ", "crystal": "é­”çµæ™¶", "fang": "é‡ç£ã®ç‰™" };

const RECIPES = [
    { id: "wep_01", name: "é‰„ã®å‰£", cost: 50, materials: { iron: 2, stone: 1 }, stat: "atk", value: 10, job: "Knight" },
    { id: "wep_02", name: "éŠ€ã®æ–", cost: 80, materials: { crystal: 2, herb: 3 }, stat: "atk", value: 15, job: "Wizard" },
    { id: "wep_03", name: "è–ãªã‚‹ç›¾", cost: 100, materials: { crystal: 1, iron: 3 }, stat: "def", value: 12, job: "Priest" }
];

let gameState = JSON.parse(JSON.stringify(INITIAL_STATE));
let currentEnemy = null;

// --- ã‚·ã‚¹ãƒ†ãƒ é–¢æ•° ---
function log(msg, type = '') {
    const lp = document.getElementById('log-panel');
    const div = document.createElement('div');
    div.className = `log-entry ${type}`;
    div.textContent = `[Floor ${gameState.floor}] ${msg}`;
    lp.prepend(div);
}

function updateUI() {
    document.getElementById('gold-display').textContent = gameState.gold;
    document.getElementById('floor-display').textContent = gameState.floor;

    // ãƒ‘ãƒ¼ãƒ†ã‚£è¡¨ç¤º
    const partyList = document.getElementById('party-list');
    partyList.innerHTML = '';
    gameState.party.forEach(m => {
        const weaponBonus = m.weapon ? m.weapon.value : 0;
        const totalAtk = m.atk + (m.weapon && m.weapon.stat === 'atk' ? weaponBonus : 0);
        const totalDef = m.def + (m.weapon && m.weapon.stat === 'def' ? weaponBonus : 0);
        
        partyList.innerHTML += `
            <div class="party-member">
                <div style="display:flex; justify-content:space-between">
                    <strong>${m.name}</strong> <small>${m.job}</small>
                </div>
                HP: ${m.hp}/${m.maxHp}
                <div class="hp-bar"><div class="hp-fill" style="width:${(m.hp/m.maxHp)*100}%"></div></div>
                MP: ${m.mp}/${m.maxMp}
                <div class="mp-bar"><div class="mp-fill" style="width:${(m.mp/m.maxMp)*100}%"></div></div>
                <div style="font-size:0.75rem; margin-top:5px; color:#aaa;">
                    ATK: ${totalAtk} / DEF: ${totalDef} <br>
                    E: ${m.weapon ? m.weapon.name : 'ãªã—'}
                </div>
            </div>`;
    });

    // åˆæˆãƒªã‚¹ãƒˆ
    const recipeDiv = document.getElementById('recipe-list');
    recipeDiv.innerHTML = '';
    RECIPES.forEach(r => {
        const canAfford = gameState.gold >= r.cost && Object.entries(r.materials).every(([k, v]) => (gameState.inventory[k] || 0) >= v);
        recipeDiv.innerHTML += `
            <div class="item-row" style="flex-direction:column; border:1px solid #444; margin-bottom:5px; padding:10px;">
                <div style="display:flex; justify-content:space-between">
                    <strong>${r.name} (${r.job}ç”¨)</strong>
                    <span class="gold">${r.cost}G</span>
                </div>
                <div style="font-size:0.8rem; color:#bbb;">åŠ¹æœ: ${r.stat.toUpperCase()}+${r.value}</div>
                <div style="font-size:0.8rem;">å¿…è¦: ${Object.entries(r.materials).map(([k,v])=>`${ITEMS[k]}x${v}`).join(' ')}</div>
                <button onclick="craftItem('${r.id}')" ${canAfford ? '' : 'disabled'} style="margin-top:5px;">åˆæˆã™ã‚‹</button>
            </div>`;
    });

    // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªè¦ç´„
    const invSum = document.getElementById('inventory-summary');
    invSum.innerHTML = '<small>ç´ æ: ' + Object.entries(gameState.inventory).filter(([k,v])=>v>0).map(([k,v])=>`${ITEMS[k]}x${v}`).join(', ') + '</small>';

    // è£…å‚™ãƒªã‚¹ãƒˆ
    const equipDiv = document.getElementById('equip-list');
    equipDiv.innerHTML = '';
    if(gameState.ownedEquipment.length === 0) equipDiv.innerHTML = '<p>æ‰€æŒå“ãªã—</p>';
    gameState.ownedEquipment.forEach((eq, index) => {
        equipDiv.innerHTML += `
            <div class="item-row">
                <span>${eq.name} (${eq.stat.toUpperCase()}+${eq.value})</span>
                <select onchange="equipItem(${index}, this.value)">
                    <option value="-1">æœªè£…å‚™</option>
                    ${gameState.party.map((m, i) => `<option value="${i}" ${m.weapon && m.weapon.instanceId === eq.instanceId ? 'selected' : ''}>${m.name}</option>`).join('')}
                </select>
            </div>`;
    });
}

function changeScene(scene) {
    document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
    document.getElementById(`${scene}-view`).classList.remove('hidden');
    if(scene !== 'explore') {
        document.getElementById('explore-idle').classList.remove('hidden');
        document.getElementById('battle-area').classList.add('hidden');
        currentEnemy = null;
    }
    updateUI();
    saveGame();
}

// --- æˆ¦é—˜ãƒ­ã‚¸ãƒƒã‚¯ ---
function startExplore() {
    document.getElementById('explore-idle').classList.add('hidden');
    document.getElementById('battle-area').classList.remove('hidden');
    spawnEnemy();
}

function spawnEnemy() {
    const f = gameState.floor;
    const names = ["ã‚¹ãƒ©ã‚¤ãƒ ", "ã‚´ãƒ–ãƒªãƒ³", "ã‚ªãƒ¼ã‚¯", "ã‚¹ã‚±ãƒ«ãƒˆãƒ³", "ã‚´ãƒ¼ãƒ¬ãƒ ", "ãƒ‡ãƒ¼ãƒ¢ãƒ³", "ãƒ‰ãƒ©ã‚´ãƒ³"];
    const name = names[Math.min(names.length-1, Math.floor(f/3))] + (f > 10 ? "+" : "");
    
    currentEnemy = {
        name: name,
        hp: 20 + (f * 15),
        maxHp: 20 + (f * 15),
        atk: 5 + (f * 3),
        gold: 10 + (f * 5),
        drops: ["stone", "herb", "iron", "crystal", "fang"]
    };
    
    document.getElementById('next-btn').classList.add('hidden');
    document.getElementById('retreat-btn').classList.remove('hidden');
    log(`${currentEnemy.name} ãŒç¾ã‚ŒãŸï¼`);
    updateBattleUI();
}

function updateBattleUI() {
    if(!currentEnemy) return;
    document.getElementById('enemy-name').textContent = `${currentEnemy.name} (Lv.${gameState.floor})`;
    document.getElementById('enemy-hp-fill').style.width = `${(currentEnemy.hp/currentEnemy.maxHp)*100}%`;
}

function battleTurn(type) {
    if(!currentEnemy || currentEnemy.hp <= 0) return;

    // å‘³æ–¹ã®ã‚¿ãƒ¼ãƒ³
    gameState.party.forEach(m => {
        if(m.hp <= 0 || currentEnemy.hp <= 0) return;
        
        const weaponBonus = (m.weapon && m.weapon.stat === 'atk') ? m.weapon.value : 0;
        const baseAtk = m.atk + weaponBonus;

        if(type === 'skill' && m.mp >= m.skillCost) {
            m.mp -= m.skillCost;
            if(m.id === 0) { // å‹‡è€…: å˜ä½“å¼·æ’ƒ
                let d = Math.floor(baseAtk * 2.5);
                currentEnemy.hp -= d;
                log(`${m.name}ã®${m.skillName}ï¼ ${currentEnemy.name}ã«${d}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`, 'log-hit');
            } else if(m.id === 1) { // é­”å°å£«: å…¨ä½“ï¼ˆã“ã“ã§ã¯å˜ä½“å¼·èª¿ï¼‰
                let d = Math.floor(baseAtk * 2.0);
                currentEnemy.hp -= d;
                log(`${m.name}ã®${m.skillName}ï¼ åºƒç¯„å›²ã‚’ç„¼ãæ‰•ã„${d}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`, 'log-hit');
            } else if(m.id === 2) { // åƒ§ä¾¶: å…¨ä½“å›å¾©
                gameState.party.forEach(p => p.hp = Math.min(p.maxHp, p.hp + 20));
                log(`${m.name}ã®${m.skillName}ï¼ ãƒ‘ãƒ¼ãƒ†ã‚£ã®HPãŒå›å¾©ï¼`, 'log-heal');
            }
        } else {
            let d = Math.max(1, baseAtk - Math.floor(gameState.floor));
            currentEnemy.hp -= d;
            log(`${m.name}ã®æ”»æ’ƒï¼š${d}ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚`);
        }
    });

    if(currentEnemy.hp <= 0) {
        winBattle();
    } else {
        // æ•µã®ã‚¿ãƒ¼ãƒ³
        const alive = gameState.party.filter(p => p.hp > 0);
        const target = alive[Math.floor(Math.random()*alive.length)];
        const weaponDef = (target.weapon && target.weapon.stat === 'def') ? target.weapon.value : 0;
        const dmg = Math.max(1, currentEnemy.atk - (target.def + weaponDef));
        target.hp = Math.max(0, target.hp - dmg);
        log(`${currentEnemy.name}ã®æ”»æ’ƒï¼ ${target.name}ã«${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`, 'log-hit');

        if(gameState.party.every(p => p.hp <= 0)) {
            log("å…¨æ»…ã—ãŸ... ç”ºã¸å¼·åˆ¶å¸°é‚„ã€‚");
            gameState.floor = Math.max(1, gameState.floor - 1);
            gameState.party.forEach(p => p.hp = 1);
            changeScene('town');
        }
    }
    updateUI();
    updateBattleUI();
}

function winBattle() {
    log(`${currentEnemy.name}ã‚’æ’ƒç ´ï¼`);
    gameState.gold += currentEnemy.gold;
    log(`${currentEnemy.gold}G ç²å¾—ã€‚`);

    // ãƒ‰ãƒ­ãƒƒãƒ—åˆ¤å®š
    const drop = currentEnemy.drops[Math.floor(Math.random() * currentEnemy.drops.length)];
    if(Math.random() > 0.4) {
        gameState.inventory[drop] = (gameState.inventory[drop] || 0) + 1;
        log(`ç´ æã€${ITEMS[drop]}ã€‘ã‚’æ‹¾ã£ãŸã€‚`);
    }

    document.getElementById('next-btn').classList.remove('hidden');
    document.getElementById('retreat-btn').classList.add('hidden');
}

function proceedFloor() {
    gameState.floor++;
    spawnEnemy();
}

// --- ç”ºãƒ»è£…å‚™ãƒ­ã‚¸ãƒƒã‚¯ ---
function rest() {
    if(gameState.gold >= 15) {
        gameState.gold -= 15;
        gameState.party.forEach(p => { p.hp = p.maxHp; p.mp = p.maxMp; });
        log("å®¿å±‹ã«å®¿æ³Šã—ã¾ã—ãŸã€‚HP/MPå…¨å¿«ï¼");
        updateUI();
    } else {
        log("ãŠé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
    }
}

function craftItem(recipeId) {
    const r = RECIPES.find(x => x.id === recipeId);
    gameState.gold -= r.cost;
    Object.entries(r.materials).forEach(([k,v]) => gameState.inventory[k] -= v);
    
    const newEquip = {
        ...r,
        instanceId: Date.now() + Math.random(),
    };
    gameState.ownedEquipment.push(newEquip);
    log(`åˆæˆæˆåŠŸï¼š${r.name}ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼`);
    updateUI();
}

function equipItem(equipIdx, charIdx) {
    const equip = gameState.ownedEquipment[equipIdx];
    charIdx = parseInt(charIdx);

    // ä»–ã®äººãŒæŒã£ã¦ã„ãŸã‚‰å¤–ã™
    gameState.party.forEach(m => {
        if(m.weapon && m.weapon.instanceId === equip.instanceId) m.weapon = null;
    });

    if(charIdx !== -1) {
        gameState.party[charIdx].weapon = equip;
        log(`${gameState.party[charIdx].name}ã«${equip.name}ã‚’è£…å‚™ã•ã›ãŸã€‚`);
    }
    updateUI();
}

// --- ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰ ---
function saveGame() {
    localStorage.setItem('hacksla_rpg_save', JSON.stringify(gameState));
    log("ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–å®Œäº†ã€‚");
}

function loadGame() {
    const saved = localStorage.getItem('hacksla_rpg_save');
    if(saved) {
        gameState = JSON.parse(saved);
        log("ãƒ­ãƒ¼ãƒ‰å®Œäº†ã€‚å†’é™ºã‚’å†é–‹ã—ã¾ã™ã€‚");
    }
    updateUI();
}

loadGame();
</script>
</body>
</html>
